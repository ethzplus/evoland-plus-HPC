<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; Setup and Usage</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../summary.html" rel="next">
<link href="../structure.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-bc185b5c5bdbcb35c2eb49d8a876ef70.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d5cd2b7852de7ff0572e8d2fd9bdda34.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-832f86d964bc4b082e5bd017499304cb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-d5cd2b7852de7ff0572e8d2fd9bdda34.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../pipeline/pipeline.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Setup and Usage</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
        <div class="sidebar-tools-collapse">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">evoland+ HPC Guide</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Structure</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pipeline/pipeline.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Setup and Usage</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">3.1</span> Setup</a>
  <ul class="collapse">
  <li><a href="#requirements" id="toc-requirements" class="nav-link" data-scroll-target="#requirements"><span class="header-section-number">3.1.1</span> Requirements</a></li>
  <li><a href="#evoland-plus-hpc-repository" id="toc-evoland-plus-hpc-repository" class="nav-link" data-scroll-target="#evoland-plus-hpc-repository"><span class="header-section-number">3.1.2</span> evoland-plus HPC Repository</a></li>
  </ul></li>
  <li><a href="#steps" id="toc-steps" class="nav-link" data-scroll-target="#steps"><span class="header-section-number">3.2</span> Steps</a></li>
  <li><a href="#10_LULCC" id="toc-10_LULCC" class="nav-link" data-scroll-target="#10_LULCC"><span class="header-section-number">3.3</span> Land Use Land Cover Change</a>
  <ul class="collapse">
  <li><a href="#simulation-control-table" id="toc-simulation-control-table" class="nav-link" data-scroll-target="#simulation-control-table"><span class="header-section-number">3.3.1</span> Simulation Control Table</a></li>
  <li><a href="#container-setup" id="toc-container-setup" class="nav-link" data-scroll-target="#container-setup"><span class="header-section-number">3.3.2</span> Container Setup</a></li>
  </ul></li>
  <li><a href="#11_CheckLULCC" id="toc-11_CheckLULCC" class="nav-link" data-scroll-target="#11_CheckLULCC"><span class="header-section-number">3.4</span> Check LULCC</a></li>
  <li><a href="#20_FocalLULC" id="toc-20_FocalLULC" class="nav-link" data-scroll-target="#20_FocalLULC"><span class="header-section-number">3.5</span> Focal LULC</a></li>
  <li><a href="#40_NCPs" id="toc-40_NCPs" class="nav-link" data-scroll-target="#40_NCPs"><span class="header-section-number">3.6</span> Nature’s Contributions to People</a>
  <ul class="collapse">
  <li><a href="#ncps" id="toc-ncps" class="nav-link" data-scroll-target="#ncps"><span class="header-section-number">3.6.1</span> NCPs</a></li>
  <li><a href="#running-the-ncp-calculation" id="toc-running-the-ncp-calculation" class="nav-link" data-scroll-target="#running-the-ncp-calculation"><span class="header-section-number">3.6.2</span> Running the NCP calculation</a></li>
  </ul></li>
  <li><a href="#running" id="toc-running" class="nav-link" data-scroll-target="#running"><span class="header-section-number">3.7</span> Running</a>
  <ul class="collapse">
  <li><a href="#evoland-plus-hpc-pipeline" id="toc-evoland-plus-hpc-pipeline" class="nav-link" data-scroll-target="#evoland-plus-hpc-pipeline"><span class="header-section-number">3.7.1</span> evoland-plus HPC pipeline</a></li>
  <li><a href="#check-lulcc-and-focal-lulc" id="toc-check-lulcc-and-focal-lulc" class="nav-link" data-scroll-target="#check-lulcc-and-focal-lulc"><span class="header-section-number">3.7.2</span> Check LULCC and Focal LULC</a></li>
  <li><a href="#logging" id="toc-logging" class="nav-link" data-scroll-target="#logging"><span class="header-section-number">3.7.3</span> Logging</a></li>
  </ul></li>
  <li><a href="#further-steps" id="toc-further-steps" class="nav-link" data-scroll-target="#further-steps"><span class="header-section-number">4</span> Further Steps</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ethzplus/evoland-plus-HPC/issues/new/choose" class="toc-action"><i class="bi bi-chat-right"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Setup and Usage</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The evoland-plus HPC pipeline consists out of various scripts that can be found in the <code>src</code> directory. For each included step of <a href="../structure.html#fig-pipeline" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>, there is a subdirectory in <code>src/steps</code>.</p>
<p>This part is structured as follows:</p>
<ul>
<li><a href="setup.qmd">Setup</a></li>
<li><a href="#steps">Steps</a>
<ul>
<li><a href="../pipeline/10_LULCC.qmd">LULCC</a></li>
<li><a href="../pipeline/11_CheckLULCC.qmd">Check LULCC</a></li>
<li><a href="../pipeline/20_FocalLULC.qmd">Focals</a></li>
<li><a href="../pipeline/40_NCPs.qmd">NCPs</a></li>
</ul></li>
<li><a href="../pipeline/running.qmd">Running the pipeline</a></li>
</ul>
<p>The task of the evoland-plus HPC pipeline is to streamline the process, so that varying the climate scenarios and other parameters can be carried out efficiently. Introducing parallelization through <a href="https://slurm.schedmd.com/overview.qmd">SLURM</a> batch jobs, and adding HPC compatibility, are the main tasks of the pipeline. Meanwhile, the pipeline keeps track of the intermediate results, a centralized configuration file, and the execution of each step. Details on the individual steps are given in the following sections.</p>
<section id="setup" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="setup"><span class="header-section-number">3.1</span> Setup</h2>
<p>Before you set up the evoland-plus HPC pipeline, you should make sure to satisfy a few requirements. This section will go over <a href="#hardware">hardware</a> and <a href="#software">software</a> requirements, and then guide you through the <a href="#future-ei-repository">evoland-plus HPC repository</a> setup. The following pages guide through the details of each step in the pipeline, before concluding with the <a href="running.html">execution</a> of the pipeline.</p>
<section id="requirements" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="requirements"><span class="header-section-number">3.1.1</span> Requirements</h3>
<p>We are using a Linux cluster with <a href="https://slurm.schedmd.com/overview.html">SLURM</a> as scheduler. If your cluster uses a different scheduler, you can see if it is compatible with the SLURM syntax, or you can adapt the scripts to your scheduler.</p>
<div id="cau-linux-cluster" class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;3.1: What is a Linux cluster?
</div>
</div>
<div class="callout-body-container callout-body">
<p>As this pipeline is specifically designed to simulate a large number of scenarios, it has been optimized for high-performance computing (HPC) environments. If you only need to run a few scenarios, it might be easier to run the steps manually. Otherwise, you do need to have access to a Linux cluster with SLURM. Feel free to reach out to a technically savvy colleague or your local HPC support for help.</p>
</div>
</div>
<section id="hardware" class="level4" data-number="3.1.1.1">
<h4 data-number="3.1.1.1" class="anchored" data-anchor-id="hardware"><span class="header-section-number">3.1.1.1</span> Hardware</h4>
<p>The minimum memory and CPU requirements cannot generally be stated, as they depend on the area of interest, input data, and the number of scenarios. A viable starting point for a country with the size of Switzerland, using a resolution of 100&nbsp;m, is 16&nbsp;GB of memory and 4&nbsp;CPUs. This is the case for a few scenarios and no parallelization within the steps. Scaling up to around 1000 scenarios, we suggest at least 128&nbsp;GB of memory and 16&nbsp;CPUs, to achieve a viable runtime. As this is an estimate, it is essential to monitor runtime before scaling up.</p>
</section>
<section id="software" class="level4" data-number="3.1.1.2">
<h4 data-number="3.1.1.2" class="anchored" data-anchor-id="software"><span class="header-section-number">3.1.1.2</span> Software</h4>
<p>Additionally, you need to install the following software:</p>
<section id="micromambaconda" class="level5" data-number="3.1.1.2.1">
<h5 data-number="3.1.1.2.1" class="anchored" data-anchor-id="micromambaconda"><span class="header-section-number">3.1.1.2.1</span> Micromamba/Conda</h5>
<p>For some pipeline steps, we use conda environments. <a href="https://docs.conda.io/projects/conda/en/stable/">Conda</a> is a package manager that helps you manage dependencies in isolated environments. We recommend using <a href="https://mamba.readthedocs.io/en/latest/"><code>micromamba</code></a>, which does the same job as Conda, but resolves dependencies much faster, with the flexibility of <a href="https://docs.conda.io/en/latest/miniconda.html"><code>miniconda</code></a> (CLI of Conda). Find the installation instructions for Micromamba <a href="https://mamba.readthedocs.io/en/latest/installation/micromamba-installation.html">here</a>. We have added compatibility for <code>micromamba</code>, <code>mamba</code> and <code>conda</code>, in this order of preference, but only tested with <code>micromamba</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>We have chosen <a href="https://conda-forge.org/"><code>conda-forge</code></a> as the default channel for the conda environments, as it is a single source for our <code>R</code>, Python, and lower-level dependencies (e.g., <code>gdal</code>, <code>proj</code>). This is independent of the modules and applications provided by the HPC environment.</p>
</section>
<section id="apptainer" class="level5" data-number="3.1.1.2.2">
<h5 data-number="3.1.1.2.2" class="anchored" data-anchor-id="apptainer"><span class="header-section-number">3.1.1.2.2</span> Apptainer</h5>
<p>Running containerized applications on HPCs can be challenging. To simplify the process, we use the <a href="https://apptainer.org/">Apptainer</a> (formerly Singularity) container runtime. Make sure your HPC environment supports Apptainer, and that you have the necessary permissions to run containers. If this is not the case, contact your HPC support team for help.</p>
</section>
<section id="docker" class="level5" data-number="3.1.1.2.3">
<h5 data-number="3.1.1.2.3" class="anchored" data-anchor-id="docker"><span class="header-section-number">3.1.1.2.3</span> Docker</h5>
<p>Building the LULCC container requires Docker<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> before converting it to the Apptainer format. The <code>lulcc</code> container uses the <a href="https://github.com/cbueth/dinamica-ego-docker/"><code>dinamica-ego-docker</code></a> container (version <code>7.5</code>).</p>
<p>This step can be done on a local machine, and will be explained in the <a href="10_LULCC.html">LULCC</a> step.</p>
</section>
<section id="dinamica-ego" class="level5" data-number="3.1.1.2.4">
<h5 data-number="3.1.1.2.4" class="anchored" data-anchor-id="dinamica-ego"><span class="header-section-number">3.1.1.2.4</span> Dinamica EGO</h5>
<p>Dinamica EGO is an environmental modeling platform used in the LULCC step. It is available on <a href="https://dinamicaego.com/">the project website</a>. But as aforementioned, it will be used from the LULCC docker image, as it is only integrated from the command line interface (CLI), not with the usual graphical user interface (GUI).</p>
</section>
<section id="yaml-parser-yq" class="level5" data-number="3.1.1.2.5">
<h5 data-number="3.1.1.2.5" class="anchored" data-anchor-id="yaml-parser-yq"><span class="header-section-number">3.1.1.2.5</span> Yaml Parser <code>yq</code></h5>
<p>For the <code>bash</code> scripts, we use <a href="https://mikefarah.gitbook.io/yq/"><code>yq</code></a> to parse the <code>yaml</code> configuration file. <code>yq</code> needs to be available in the <code>PATH</code> variable of the shell. To install the latest version<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, run the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="va">bin_dir</span><span class="op">=</span>/usr/bin <span class="kw">&amp;&amp;</span><span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 <span class="at">-O</span> <span class="va">$bin_dir</span>/yq</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x <span class="va">$bin_dir</span>/yq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Other <a href="https://github.com/mikefarah/yq/#install">installation options</a> and binaries can be found on the repository’s README. To make <code>yq</code> available in the <code>PATH</code> variable, make sure the <code>$bin_dir</code> is in the <code>PATH</code> variable. To check the parser is installed correctly, run <code>yq --version</code> in the shell.</p>
</section>
<section id="lulcc-repository" class="level5" data-number="3.1.1.2.6">
<h5 data-number="3.1.1.2.6" class="anchored" data-anchor-id="lulcc-repository"><span class="header-section-number">3.1.1.2.6</span> LULCC Repository</h5>
<p>The version used for evoland-plus HPC is a reduced version of the original model, adapted for containerized execution on HPCs, and can be found on the <a href="https://github.com/blenback/LULCC-CH/tree/hpc"><code>hpc</code> branch</a> of the repository. Clone the repository to the HPC using git or download the repository as a zip. If you have never used git before, search online for a guide on how to clone a repository.</p>
</section>
</section>
</section>
<section id="evoland-plus-hpc-repository" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="evoland-plus-hpc-repository"><span class="header-section-number">3.1.2</span> evoland-plus HPC Repository</h3>
<p>After you have set up the requirements, you can clone the <a href="https://github.com/ethzplus/evoland-plus-HPC">evoland-plus HPC repository</a>. This repository contains the pipeline and all necessary scripts to run it.</p>
<p>Before you start the pipeline, you need to configure the pipeline. These settings are centralized in the <code>config.yml</code> file. There are only a few mandatory changes we will highlight, but you can find more settings with descriptive names in the file.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config.yml</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="src/config.yml" data-code-copy="false"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bash variables</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bash_variables</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">FUTURE_EI_CONFIG_FILE</span><span class="kw">:</span><span class="at"> ~/evoland-plus HPC/src/config.yml</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">FUTURE_EI_OUTPUT_DIR</span><span class="kw">:</span><span class="at"> ~/evoland-plus HPC-Output</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="at">  ...</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # LULCC HPC version</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_CH_HPC_DIR</span><span class="kw">:</span><span class="at"> ~/LULCC-CH</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="at">  ...</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">  # Overwrites $TMPDIR if not set by the system. $TMPDIR is used by Dinamica EGO.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">  # and conda/libmamba</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ALTERNATIVE_TMPDIR</span><span class="kw">:</span><span class="at"> /scratch</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each script, <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/bash_common.sh"><code>src/bash_common.sh</code></a> is sourced to set the environment variables. First, <code>FUTURE_EI_CONFIG_FILE</code> needs to be set to the absolute path of this configuration file. <code>FUTURE_EI_OUTPUT_DIR</code> is the directory where the outputs of the pipeline will be stored. As the pipeline needs a multiple more temporary space than the output itself, having a fast and large temporary directory is crucial. If the HPC does not set the <code>$TMPDIR</code> variable, you can set it to a different directory using <code>ALTERNATIVE_TMPDIR</code>. This will be used in the LULCC and NCP steps for temporary files. Finally, <code>LULCC_CH_HPC_DIR</code> is the directory where the LULCC repository is stored, which was cloned in the <a href="#lulcc-repository">previous step</a>.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config.yml</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="src/config.yml" data-code-copy="false"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Focal LULC</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">FocalLULCC</span><span class="kw">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="at">  ...</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># LULC check</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">CheckLULCC</span><span class="kw">:</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">  ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To mention the <code>FocalLULCC</code> and <code>CheckLULCC</code> sections, these are settings dedicated to separate steps in the pipeline and are specifically loaded in the respective scripts. We will touch on these settings in the respective steps. To see the current settings (and test <code>yq</code>), print the contents of <code>config.yml</code> as idiomatic YAML to stdout:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">yq</span> <span class="at">-P</span> <span class="at">-oy</span> src/config.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As a last general note, make sure to set the permissions of the scripts to executable. To make all bash scripts in the source executable, give them the permission as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># possibly activate globstar: shopt -s globstar</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x src/<span class="pp">**</span>/<span class="pp">*</span>.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The next sections will guide you through the setup of each step in the pipeline.</p>
</section>
</section>
<section id="steps" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="steps"><span class="header-section-number">3.2</span> Steps</h2>
</section>
<section id="10_LULCC" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="10_LULCC"><span class="header-section-number">3.3</span> Land Use Land Cover Change</h2>
<p>LULCC is a <a href="https://dinamicaego.com"><code>Dinamica EGO</code></a> <span class="citation" data-cites="dinamicaEGO">(<a href="../references.html#ref-dinamicaEGO" role="doc-biblioref">Leite-Filho et al. 2020</a>)</span> model, and makes use of the <a href="https://www.r-project.org/"><code>R</code></a> <span class="citation" data-cites="r2022">(<a href="../references.html#ref-r2022" role="doc-biblioref">R Core Team 2022</a>)</span> ecosystem, including packages from the Comprehensive R Archive Network (CRAN). You can find the LULCC model, as well as an adapted version for use with evoland-plus HPC, in the <a href="https://github.com/blenback/LULCC-CH">LULCC repository</a> <span class="citation" data-cites="lulcc2024">(<a href="../references.html#ref-lulcc2024" role="doc-biblioref">Black 2024</a>)</span>, as mentioned in the <a href="#lulcc-repository">setup section</a>.</p>
<div id="cau-versions" class="callout callout-style-simple callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution&nbsp;3.2: Used Versions in this step
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Covered by <a href="https://hub.docker.com/repository/docker/cbueth/lulcc/general">LULCC docker</a> <code>0.3.0</code>:
<ul>
<li>Dinamica EGO: <code>7.5</code></li>
<li>R: <code>4.3.2</code>
<ul>
<li>raster: <code>3.6-26</code></li>
<li><a href="#note-versions">Further R packages</a><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<p>LULCC needs a variety of inputs. These are set via environment variables in the <code>src/config.yml</code> file — the assumption being that the <code>src</code> directory contains project-specific code, and hence also setup details. Here is an excerpt of the file:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config.yml</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="src/config.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bash variables</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bash_variables</span><span class="kw">:</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="at">  ...</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">  # Model Variables - from LULCC_CH_HPC root</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_CLASS_AGG</span><span class="kw">:</span><span class="at"> Tools/LULC_class_aggregation.xlsx</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_SPEC</span><span class="kw">:</span><span class="at"> Tools/Model_specs.csv</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_PARAM_GRID</span><span class="kw">:</span><span class="at"> Tools/param-grid.xlsx</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_PRED_TABLE</span><span class="kw">:</span><span class="at"> Tools/Predictor_table.xlsx</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_REF_GRID</span><span class="kw">:</span><span class="at"> Data/Ref_grid.tif</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_CAL_PARAM_DIR</span><span class="kw">:</span><span class="at"> Data/Allocation_parameters/Calibration</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_SIM_PARAM_DIR</span><span class="kw">:</span><span class="at"> Data/Allocation_parameters/Simulation</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_RATE_TABLE_DIR</span><span class="kw">:</span><span class="at"> Data/Transition_tables/prepared_trans_tables</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_SIM_CONTROL_TABLE</span><span class="kw">:</span><span class="at"> ~/LULCC-CH/Tools/Simulation_control.csv</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_SPAT_INTS_TABLE</span><span class="kw">:</span><span class="at"> Tools/Spatial_interventions.csv</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_EI_INTS_TABLE</span><span class="kw">:</span><span class="at"> Tools/EI_interventions.csv</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_SCENARIO_SPEC</span><span class="kw">:</span><span class="at"> Tools/Scenario_specs.csv</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_EI_LAYER_DIR</span><span class="kw">:</span><span class="at"> Data/EI_intervention_layers</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_REMOVE_PRED_PROB_MAPS</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span><span class="co"> # remove prediction probability maps after</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">  # simulation if 1, True or TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A relevant parameter to change is the <code>LULCC_M_SIM_CONTROL_TABLE</code> variable. This is the only path that is absolute, and it should point to the <code>Simulation_control.csv</code> file. All further paths are relative to the LULCC repository root: the files under <code>Tools</code> are configuration files, while the <code>Data</code> directory contains input and working data. For information on the further variables, see the <a href="https://github.com/blenback/LULCC-CH">LULCC repository</a> and paper <span class="citation" data-cites="lulcc2024">(<a href="../references.html#ref-lulcc2024" role="doc-biblioref">Black 2024</a>)</span>.</p>
<section id="simulation-control-table" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="simulation-control-table"><span class="header-section-number">3.3.1</span> Simulation Control Table</h3>
<p><code>Simulation_control.csv</code> is a table that controls the scenarios to be simulated, including the data described in <a href="#tbl-simulation-control" class="quarto-xref">Table&nbsp;<span>3.1</span></a>. This format extends the original format from the LULCC model.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>~/LULCC-CH/Tools/Simulation_control.csv</strong></pre>
</div>
<pre class="csv" data-filename="~/LULCC-CH/Tools/Simulation_control.csv"><code>Simulation_num.,Scenario_ID.string,Simulation_ID.string,Model_mode.string,Scenario_start.real,Scenario_end.real,Step_length.real,Parallel_TPC.string,Pop_scenario.string,Econ_scenario.string,Climate_scenario.string,Spatial_interventions.string,EI_interventions.string,Deterministic_trans.string,Completed.string,EI_ID.string
1,BAU,1,Simulation,2020,2060,5,N,Ref,Ref_Central,rcp45,Y,Y,Y,N,1
217,EINAT,217,Simulation,2020,2060,5,N,Low,Ecolo_Urban,rcp26,Y,Y,Y,N,217
433,EICUL,433,Simulation,2020,2060,5,N,Ref,Ecolo_Central,rcp26,Y,Y,Y,N,433
649,EISOC,649,Simulation,2020,2060,5,N,Ref,Combined_Urban,rcp45,Y,Y,Y,N,649
865,BAU,865,Simulation,2020,2060,5,N,Ref,Ref_Central,rcp85,Y,Y,Y,N,1</code></pre>
</div>
<p>Each colum describes one scenario to be simulated. This table controls which data is used to simulate the land use changes.</p>
<div id="tbl-simulation-control" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-simulation-control-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3.1: Description of the columns in the <code>Simulation_control.csv</code> file.
</figcaption>
<div aria-describedby="tbl-simulation-control-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Simulation_num.</code></td>
<td>The number of the simulation.</td>
</tr>
<tr class="even">
<td><code>Scenario_ID.string</code></td>
<td>The scenario ID.</td>
</tr>
<tr class="odd">
<td><code>Simulation_ID.string</code></td>
<td>The simulation ID.</td>
</tr>
<tr class="even">
<td><code>Model_mode.string</code></td>
<td>The model mode.</td>
</tr>
<tr class="odd">
<td><code>Scenario_start.real</code></td>
<td>The start year of the scenario.</td>
</tr>
<tr class="even">
<td><code>Scenario_end.real</code></td>
<td>The end year of the scenario.</td>
</tr>
<tr class="odd">
<td><code>Step_length.real</code></td>
<td>The length of the steps.</td>
</tr>
<tr class="even">
<td><code>Parallel_TPC.string</code></td>
<td>Whether the simulation is parallelized.</td>
</tr>
<tr class="odd">
<td><code>Pop_scenario.string</code></td>
<td>The population scenario.</td>
</tr>
<tr class="even">
<td><code>Econ_scenario.string</code></td>
<td>The economic scenario.</td>
</tr>
<tr class="odd">
<td><code>Climate_scenario.string</code></td>
<td>The climate scenario (e.g., <code>rcp45</code>, <code>rcp26</code>, <code>rcp85</code>).</td>
</tr>
<tr class="even">
<td><code>Spatial_interventions.string</code></td>
<td>Whether spatial interventions are used.</td>
</tr>
<tr class="odd">
<td><code>EI_interventions.string</code></td>
<td>Whether EI interventions are used</td>
</tr>
<tr class="even">
<td><code>Deterministic_trans.string</code></td>
<td>Whether deterministic transitions are used.</td>
</tr>
<tr class="odd">
<td><code>Completed.string</code></td>
<td>Whether the simulation is completed.</td>
</tr>
<tr class="even">
<td><code>EI_ID.string</code></td>
<td>The EI ID.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="container-setup" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="container-setup"><span class="header-section-number">3.3.2</span> Container Setup</h3>
<p>For a platform independent execution of Dinamica EGO, we created a <a href="https://github.com/cbueth/dinamica-ego-docker/"><code>dinamica-ego-docker</code> container</a> container. This way, the glibc version is fixed, and the container can be used system independently<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. This one is used in the LULCC docker container. Our Dockerfile <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/10_LULCC/Dockerfile"><code>src/steps/10_LULCC/Dockerfile</code></a> then adds the necessary R packages for LULCC to the container. The Apptainer Definition File <a href="https://github.%20com/cbueth/evoland-plus%20HPC/tree/main/src/steps/10_LULCC/lulcc.def"><code>src/steps/10_LULCC/lulcc.def</code></a> bootstraps the docker container, mounts the <code>LULCC_CH_HPC_DIR</code> to the <code>/model</code> directory (it is not shipped within the container), and translates the entry point to the Apptainer format. This includes adding the necessary environment variables, connecting the <a href="#simulation-control-table">Simulation Control Table</a>, pointing Dinamica EGO to the correct R binary, among other details found in the Definition File. <a href="#fig-docker-setup" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> summarizes the levels of wrapping.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-docker-setup" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-docker-setup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-docker-setup">flowchart LR
    Dinamica([Dinamica EGO]) --&gt; Docker(dinamica-ego-docker)
    Docker --&gt; LULCC(LULCC docker)
    LULCC --&gt; Apptainer[Apptainer container]

    style Dinamica color:#2780e3, fill:#e9f2fc, stroke:#000000
    style Docker color:#0e7895, fill:#cbf4ff, stroke:#000000
    style LULCC color:#0e7895, fill:#cbf4ff, stroke:#000000
    style Apptainer color:#07946e, fill:#def9f2, stroke:#000000
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-docker-setup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Visualization on how Dinamica EGO is wrapped until it can be used in Apptainer on the HPC.
</figcaption>
</figure>
</div>
</div>
</div>
<p>To load the LULCC docker onto your system, it can be automatically installed or built using the <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/10_LULCC/docker_setup.sh"><code>src/steps/10_LULCC/docker_setup.sh</code></a> script, which uses variables from the <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/config.yml"><code>src/config.yml</code></a>. If you have <code>docker</code> installed, the setup script guides you through the building, pushing, or pulling of the LULCC docker container. This step can be done on a local machine. Consecutively, when having <code>apptainer</code> installed, the LULCC docker can be converted to an Apptainer container. On the HPC, this latter step suffices if you use the pre-configured <code>LULCC_DOCKER_REPO</code>, unless you want to rebuild the container. The decisive line in the script is:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/10_LULCC/docker_setup.sh (lines 84ff)</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="src/steps/10_LULCC/docker_setup.sh (lines 84ff)"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apptainer</span> build <span class="dt">\</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--build-arg</span> <span class="st">"namespace=</span><span class="va">$namespace</span><span class="st">"</span> <span class="at">--build-arg</span> <span class="st">"repo=</span><span class="va">$repo</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">--build-arg</span> <span class="st">"version=</span><span class="va">$version</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="va">$APPTAINER_CONTAINERDIR</span><span class="st">/</span><span class="va">${repo}</span><span class="st">_</span><span class="va">${version}</span><span class="st">.sif"</span> <span class="st">"</span><span class="va">$SCRIPT_DIR</span><span class="st">/lulcc.def"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Depending on your system, you might want to reconfigure the Apptainer variables:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config.yml</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="src/config.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bash variables</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bash_variables</span><span class="kw">:</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="at">  ...</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">  # Apptainer variables for the apptainer container</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">APPTAINER_CONTAINERDIR</span><span class="kw">:</span><span class="at"> ~/apptainer_containers</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">APPTAINER_CACHEDIR</span><span class="kw">:</span><span class="at"> /scratch/apptainer_cache</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>APPTAINER_CONTAINERDIR</code> is used to store the Apptainer containers, and <code>APPTAINER_CACHEDIR</code> is used when building them. If your HPC does not have a <code>/scratch</code> directory, you might want to change it to another temporary directory.</p>
<p>After all previous steps are completed, you can test the LULCC model with some test scenarios in the simulation control table. <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/10_LULCC/slurm_job.sh"><code>src/steps/10_LULCC/slurm_job.sh</code></a> submits. Before the full, parallelized simulation can be started, read the following sections.</p>
</section>
</section>
<section id="11_CheckLULCC" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="11_CheckLULCC"><span class="header-section-number">3.4</span> Check LULCC</h2>
<p>For checking the LULCC output integrity of the previous step, an intensity analysis is performed. As a previous measure of checking the LULCC output integrity, a simple visual inspection of the output maps is recommended. Subsequently, the intensity analysis regards the cumulative pixel-wise change in land use and land cover (LULC) classes, and computes the contingency table over a time series, as a measure of change between each land use class. These changes should be in a realistic range (e.g., between <span class="math inline">\(0\%\)</span> and <span class="math inline">\(5\%\)</span>), otherwise this can point to issues in the input data or the model itself.</p>
<div id="cau-ia" class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;3.3
</div>
</div>
<div class="callout-body-container callout-body">
<p>This step automatically analyzes all LULCC scenarios. But it is not integrated into the main execution script, as detailed later in the <a href="running.html">Running the pipeline</a> section.</p>
</div>
</div>
<p>The configuration section for this step is as follows:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config.yml</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="src/config.yml" data-code-copy="false"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LULC check</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">CheckLULCC</span><span class="kw">:</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">InputDir</span><span class="kw">:</span><span class="co"> # keep empty to use FUTURE_EI_OUTPUT_DIR/LULCC_CH_OUTPUT_BASE_DIR</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">OutputDir</span><span class="kw">:</span><span class="co"> # keep empty to use FUTURE_EI_OUTPUT_DIR/CHECK_LULCC_OUTPUT_DIR</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">BaseName</span><span class="kw">:</span><span class="at"> LULCC_intensity_analysis</span><span class="co"> # Can be used to distinguish different runs</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Parallel</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NWorkers</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span><span class="co">  # 0 means use all available cores</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This step uses a conda environment with <code>raster~=3.6-26</code> aside further R packages. The automatic setup script <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/11_CheckLULCC/11_CheckLULCC_setup.sh"><code>src/steps/11_CheckLULCC/11_CheckLULCC_setup.sh</code></a> needs to be executed to set up the conda environment. It sets up a conda environment <code>check_lulc</code> with the packages found in <code>11_checklulcc_env.yml</code>.</p>
<p>Running the intensity analyis is as easy as <a href="https://slurm.schedmd.com/sbatch.html"><code>sbatch</code>ing</a> the job script <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/11_CheckLULCC/slurm_job.sh"><code>slurm_job.sh</code></a>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> src/steps/11_CheckLULCC/slurm_job.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>sbatch</code> command submits the job to the HPC scheduler with the running options specified in the header of the job script.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/11_CheckLULCC/slurm_job.sh (lines 1-10)</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename="src/steps/11_CheckLULCC/slurm_job.sh (lines 1-10)"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name="11_check_lulcc"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -n 1                  # Number of cores requested</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=25    # Number of CPUs per task</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=4:00:00        # Runtime</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem-per-cpu=4G      # Memory per cpu in GB (see also --mem)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --tmp=2G              # https://scicomp.ethz.ch/wiki/Using_local_scratch</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output="logs/11_check_lulcc-%j.out"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error="logs/11_check_lulcc-%j.err"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=NONE       # Mail events (NONE, </span><span class="re">BEGIN</span><span class="co">, </span><span class="re">END</span><span class="co">, FAIL, ALL)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Change these settings according to your needs and the available resources. Monitor the logs in the <code>logs</code> directory to check the progress of the job. If you want to specify more options, refer to the <a href="https://slurm.schedmd.com/sbatch.html#SECTION_OPTIONS">SLURM documentation</a> or your local HPC documentation.</p>
</section>
<section id="20_FocalLULC" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="20_FocalLULC"><span class="header-section-number">3.5</span> Focal LULC</h2>
<p>This step calculates focal statistics for the land use and land cover change (LULCC) data. The resulting focal windows are used for the N-SDM model <span class="citation" data-cites="lulcc2024">(<a href="../references.html#ref-lulcc2024" role="doc-biblioref">Black 2024</a>)</span>. It uses a similar structure to the previous <a href="#11_CheckLULCC">Check LULCC</a> step, as it uses another conda environment and this task also has a separate job script. The configuration section for this step is as follows:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config.yml</strong></pre>
</div>
<div class="sourceCode" id="cb13" data-filename="src/config.yml" data-code-copy="false"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Focal LULC</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">FocalLULCC</span><span class="kw">:</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">InputDir</span><span class="kw">:</span><span class="co"> # keep empty to use FUTURE_EI_OUTPUT_DIR/LULCC_CH_OUTPUT_BASE_DIR</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">OutputDir</span><span class="kw">:</span><span class="co"> # keep empty to use FUTURE_EI_OUTPUT_DIR/FOCAL_OUTPUT_BASE_DIR</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">BaseName</span><span class="kw">:</span><span class="at"> ch_lulc_agg11_future_pixel</span><span class="co">  # Underscores will be split into folders</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">RadiusList</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> </span><span class="dv">100</span><span class="kw">,</span><span class="at"> </span><span class="dv">200</span><span class="kw">,</span><span class="at"> </span><span class="dv">500</span><span class="kw">,</span><span class="at"> </span><span class="dv">1500</span><span class="kw">,</span><span class="at"> </span><span class="dv">3000</span><span class="at"> </span><span class="kw">]</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">WindowType</span><span class="kw">:</span><span class="at"> circle</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">FocalFunction</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Overwrite</span><span class="kw">:</span><span class="at"> </span><span class="ch">False</span><span class="co"> # False -&gt; skip if output exists, True -&gt; overwrite</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Parallel</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NWorkers</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span><span class="co">  # 0 means use all available cores</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This script recursively goes through the input directory and calculates the focal statistics for each scenario. It creates the outputs in a similar structure, inside the output directory, named after the <code>BaseName</code>. For each scenario, the focal statistics by <code>WindowType</code> and <code>FocalFunction</code> are calculated for each radius in <code>RadiusList</code>. For details, consult the docstring of the method <a href="https://github.com/ethzplus/evoland-plus-HPC/blob/main/src/steps/20_FocalLULC/20_focal_statistics.R#L260-L323"><code>20_focal_statistics::simulated_lulc_to_predictors</code></a>.</p>
<p>This step uses a conda environment with <code>raster~=3.6-26</code>, <code>terra~=1.7-71</code> (only used for conversion), and further R packages. The conda environment <code>focal_lulc</code> is set up by executing the setup script<br>
<a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/20_FocalLULC/20_FocalPrep_setup.sh"><code>src/steps/20_FocalLULC/20_FocalLULC_setup.sh</code></a>.</p>
<p>As for the previous steps, the job script <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/20_FocalLULC/slurm_job.sh"><code>slurm_job.sh</code></a> needs to be submitted to the HPC scheduler.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> src/steps/20_FocalLULC/slurm_job.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="note-focal-output" class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Focal LULC output check
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>src/steps/20_FocalLULC/show_files.py</code> script checks whether the focal window output files are complete. It verifies the presence of expected files in the output directory structure, calculates the percentage of completed files for each year, and lists any missing files. The script outputs a summary table and saves the missing file names to a text file called <code>missing_files.txt</code>.</p>
</div>
</div>
</section>
<section id="40_NCPs" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="40_NCPs"><span class="header-section-number">3.6</span> Nature’s Contributions to People</h2>
<p>Based on the code written for <span class="citation" data-cites="kuelling2024">Külling et al. (<a href="../references.html#ref-kuelling2024" role="doc-biblioref">2024</a>)</span>, we automatized the calculation of eight NCP. To note, our study includes more NCP as this, as some of them are characterized by the plain focal windows <span class="citation" data-cites="black2025">(<a href="../references.html#ref-black2025" role="doc-biblioref">Black et al. 2025</a>)</span>. (<em>Ben</em>: true?)</p>
<p>Additionally to <code>R</code> and CRAN packages, <a href="https://naturalcapitalproject.stanford.edu/software/invest"><code>InVEST</code></a> is used via the <code>Python</code> module <a href="https://pypi.org/project/natcap.invest/"><code>natcap.invest</code></a> in this step.</p>
<div id="cau-versions" class="callout callout-style-simple callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution&nbsp;3.4: Used Versions in this step
</div>
</div>
<div class="callout-body-container callout-body">
<p>Due to previous API changes, the code is compatible with <code>natcap.invest=3.13.0</code>, but not earlier versions. <code>raster=3.4-13</code> and <code>terra=1.5-21</code> are used for the NCP calculation, among other packages<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
</div>
</div>
<p>As the previous two steps, setting up the conda environment <code>ncps</code> is done using the <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/40_NCPs/40_NCPs_setup.sh"><code>src/steps/40_NCPs/40_NCPs_setup.sh</code></a> script.</p>
<section id="ncps" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="ncps"><span class="header-section-number">3.6.1</span> NCPs</h3>
<p><a href="../structure.html#tbl-ncp" class="quarto-xref">Table&nbsp;<span>2.1</span></a> lists all NCP calculated in the evoland-plus HPC project. Here, we detail the eight NCP calculated in this step. The <code>config.yml</code> file includes a few variables which are automatically used for the NCP calculation.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config.yml (54-59)</strong></pre>
</div>
<div class="sourceCode" id="cb15" data-filename="src/config.yml (54-59)"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">  # NCP variables</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_PARAMS_YML</span><span class="kw">:</span><span class="at"> ~/evoland-plus HPC/src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_SCENARIO_ID</span><span class="kw">:</span><span class="co"> # Scenario ID, automatically set for each configuration</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_YEAR</span><span class="kw">:</span><span class="co"> # Year for which to run NCPs, automatically set</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_OUTPUT_DIR</span><span class="kw">:</span><span class="co"> # Output directory for NCPs, automatically set</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_SCRATCH_DIR</span><span class="kw">:</span><span class="co"> # Scratch directory for NCPs, automatically set</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The more detailed configuration for each NCP is stored in the <code>40_NCPs_params.yml</code> file. For parallelization purposes, each array job receives a copy of this file with the respective scenario ID and year. The bash variables <code>NCP_RUN_*</code> from the <code>config.yml</code> act as a placeholder.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Params (are passed when calling the run_all_ncps.py script)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">run_params</span><span class="kw">:</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_SCENARIO_ID</span><span class="kw">:</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_YEAR</span><span class="kw">:</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_RCP</span><span class="kw">:</span><span class="co">  # programmatically set in load_params.py</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_INPUT_DIR</span><span class="kw">:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_OUTPUT_DIR</span><span class="kw">:</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NCP_RUN_SCRATCH_DIR</span><span class="kw">:</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">LULCC_M_EI_LAYER_DIR</span><span class="kw">:</span><span class="co">  # set in load_params.py (uses config.yml)  # SDR</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For preparation, it is indispensable to set the paths to the input data. Some of these are shared among multiple NCP, as noted in the comments. The first three layers are automatically found in the <code>NCP_RUN_INPUT_DIR</code> and depend on the scenario ID and year. These three are constructed with the template that the LULCC model produces, as can be seen in the <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/40_NCPs/NCP_models/load_params.py"><code>load_params.py</code></a> script.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # LULC               - CAR, FF, HAB, NDR, POL, SDR, WY</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">lulc</span><span class="kw">:</span><span class="co"> # automatically found in NCP_RUN_INPUT_DIR</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">  # Rural residential  - HAB</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">rur_res</span><span class="kw">:</span><span class="co"> # automatically found in NCP_RUN_INPUT_DIR</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">  # Urban residential  - HAB</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">urb_res</span><span class="kw">:</span><span class="co"> # automatically found in NCP_RUN_INPUT_DIR</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">  # Production regions - CAR</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">prodreg</span><span class="kw">:</span><span class="at"> Data/PRODUCTION_REGIONS/PRODREG.shp</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">  # DEM                - CAR, NDR</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">dem</span><span class="kw">:</span><span class="at"> Data/DEM_mean_LV95.tif</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">  # DEM filled         - SDR</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">dem_filled</span><span class="kw">:</span><span class="at"> Data/DEM_mean_LV95_filled.tif</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">  # Wathersheds        - NDR, SDR, WY</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">watersheds</span><span class="kw">:</span><span class="at"> Data/watersheds/watersheds.shp</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">  # Subwatersheds      - WY</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sub_watersheds</span><span class="kw">:</span><span class="at"> Data/watersheds/Subwatersheds.shp</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">  # ETO                - WY</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">eto</span><span class="kw">:</span><span class="at"> Data/evapotranspiration/</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">  # PAWC               - WY</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pawc</span><span class="kw">:</span><span class="at"> Data/Water_storage_capacity_100m_reclassified1.tif</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">  # Erodibility path   - SDR</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">erodibility_path</span><span class="kw">:</span><span class="at"> Data/Kst_LV95_ch_nib.tif</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co">  # Erosivity path     - SDR</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">erosivity_path</span><span class="kw">:</span><span class="at"> Data/rainfall_erosivity/</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co">  # Precipitation      - WY, NDR</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">yearly_precipitation</span><span class="kw">:</span><span class="at"> Data/yearly_prec/</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co">  # Soil depth         - WY</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">depth_to_root_rest_layer</span><span class="kw">:</span><span class="at"> Data/rrd_100_mm_rexport.tif</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co">  # Precipitation avgs - FF</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pavg_dir</span><span class="kw">:</span><span class="at"> Data/monthly_prec/</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="co">  # Temperature avgs   - FF</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tavg_dir</span><span class="kw">:</span><span class="at"> Data/monthly_temp/</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="co">  # Soil texture       - FF</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ph_raster</span><span class="kw">:</span><span class="at"> Data/ch_edaphic_eiv_descombes_pixel_r.tif</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="co">  # Distance to lakes  - REC</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">distlakes_path</span><span class="kw">:</span><span class="at"> Data/distlakes.tif</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Projection Settings - change for different regions</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="fu">proj</span><span class="kw">:</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="co">  # CRS</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">crs</span><span class="kw">:</span><span class="at"> epsg:2056</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="co">  # Extent</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ext</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> </span><span class="dv">2480000</span><span class="kw">,</span><span class="at"> </span><span class="dv">2840000</span><span class="kw">,</span><span class="at"> </span><span class="dv">1070000</span><span class="kw">,</span><span class="at"> </span><span class="dv">1300000</span><span class="at"> </span><span class="kw">]</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="co">  # Resolution</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">res</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cau-resolution" class="callout callout-style-simple callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution&nbsp;3.5: Resolution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make sure that the resolution of all input data is the same and matches the <code>proj.res</code> setting in the <code>40_NCPs_params.yml</code> file.</p>
</div>
</div>
<p>For each NCP, the configuration is detailed in the following sections.</p>
<section id="CAR" class="level4" data-number="3.6.1.1">
<h4 data-number="3.6.1.1" class="anchored" data-anchor-id="CAR"><span class="header-section-number">3.6.1.1</span> CAR: Regulation of climate</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CAR</span><span class="kw">:</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 1_CAR_S_CH.R</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # 2_CAR_S_CH.py</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bp_tables_dir</span><span class="kw">:</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/CAR/BPTABLE/</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # 3_CAR_S_CH.R</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">  # output prefix</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">out_prefix</span><span class="kw">:</span><span class="at"> tot_c_cur_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To calculate the carbon stored in biomass and soil, the <code>CAR</code> NCP needs biophysical tables that specify the carbon content of different land use classes. The <code>natcap.invest</code>-model <a href="https://invest.readthedocs.io/en/latest/models.html#carbon-storage-and-sequestration">Carbon Storage and Sequestration</a> is used for this calculation.</p>
</section>
<section id="FF" class="level4" data-number="3.6.1.2">
<h4 data-number="3.6.1.2" class="anchored" data-anchor-id="FF"><span class="header-section-number">3.6.1.2</span> FF: Food and feed</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FF</span><span class="kw">:</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 0_FF_ecocrop.R</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">crops_data</span><span class="kw">:</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/FF/crops.txt</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ecocrop_dir</span><span class="kw">:</span><span class="at"> evoland-plus HPC-Output/FF_preprocessing_ecocrop/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>FF</code> NCP calculates the crop production potential using the <a href="https://cropmodels.r-universe.dev/Recocrop"><code>ecocrop</code></a> package. The package uses a limiting factor approach <span class="citation" data-cites="Hackett1991">Hackett (<a href="../references.html#ref-Hackett1991" role="doc-biblioref">1991</a>)</span>. This NCP has a data preparation step which needs to be executed once before running the parallelized NCP calculation. It is a single R script that can easily be triggered with calling <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/40_NCPs/NCP_models/prepare_ncps.sh"><code>src/steps/40_NCPs/NCP_models/prepare_ncps.sh</code></a>, no SLURM needed.</p>
</section>
<section id="HAB" class="level4" data-number="3.6.1.3">
<h4 data-number="3.6.1.3" class="anchored" data-anchor-id="HAB"><span class="header-section-number">3.6.1.3</span> HAB: Habitat creation and maintenance</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb20" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">HAB</span><span class="kw">:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 0_thread_layers_generation.R</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # 1_HAB_S_CH.py</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">half_saturation_constant</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.075</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bp_table_path</span><span class="kw">:</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/HAB/BPTABLE/</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sensitivity_table_path</span><span class="kw">:</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/HAB/BPTABLE/hab_sensitivity.csv</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">threats_table_path</span><span class="kw">:</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/HAB/BPTABLE/threats.csv</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>HAB</code> NCP calculates the <a href="https://invest.readthedocs.io/en/latest/models.html#habitat-quality">habitat quality index</a>, another <code>natcap.invest</code> model. Set the three biophysical tables accordingly.</p>
<p>As we had problems how <code>natcap.invest==3.13.0</code> handles its treat layer table, we had to introduce a hotfix in the source code to keep compatibility with the existing NCP configuration. When loading in the threat layers, <code>natcap.invest</code> wants to convert the column names to lowercase to be case-insensitive, but the layer paths are also converted to lowercase, but our threat layers are case-sensitive. To fix this bug, we changed the <code>to_lower</code> argument in the <code>execute</code> function in the <code>habitat_quality.py</code> file and set the column name to match our lowercase column name.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.../ncps/lib/python3.10/site-packages/natcap/invest/habitat_quality.py (line 384)</strong></pre>
</div>
<div class="sourceCode" id="cb21" data-filename=".../ncps/lib/python3.10/site-packages/natcap/invest/habitat_quality.py (line 384)"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change from:</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>            args[<span class="st">'threats_table_path'</span>], <span class="st">'THREAT'</span>, to_lower<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># to:</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>            args[<span class="st">'threats_table_path'</span>], <span class="st">'threat'</span>, to_lower<span class="op">=</span><span class="va">False</span>,</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In later versions, the InVEST developers have changed the modality of loading in these tables. Compatibility with the latest version of <code>natcap.invest</code> can be added when adapting breaking changes with the further NPC. We want to note that changing the source code is a bad practice and should only be considered as a last resort.</p>
<p>To find the corresponding natcap folder, navigate to the environment folder, from where you find the <code>site-packages</code> folder.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># activate the ncps environment with micromamba or conda</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">micromamba</span> activate ncps</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># find the site-packages folder</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-c</span> <span class="st">"import site; print(site.getsitepackages())"</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="ex">[</span><span class="st">'.../micromamba/envs/ncps/lib/python3.10/site-packages'</span><span class="ex">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this folder, you navigate further down to find <code>.../site-packages/natcap/invest/habitat_quality.py</code>.</p>
</section>
<section id="NDR" class="level4" data-number="3.6.1.4">
<h4 data-number="3.6.1.4" class="anchored" data-anchor-id="NDR"><span class="header-section-number">3.6.1.4</span> NDR: Nutrient Delivery Ratio</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb23" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">NDR</span><span class="kw">:</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 1_NDR_S_CH.py</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # Biophysical table</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">biophysical_table_path</span><span class="kw">:</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/NDR/BPTABLE/ndr_bptable_ds25_futei.csv</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">calc_n</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">calc_p</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">k_param</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">  # Suffix for output files</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">  # Subsurface critical length</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">subsurface_critical_length_n</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">  # Subsurface effective retention</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">subsurface_eff_n</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.75</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">  # Threshold flow accumulation</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">threshold_flow_accumulation</span><span class="kw">:</span><span class="at"> </span><span class="dv">200</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>NDR</code> NCP calculates the <a href="https://invest.readthedocs.io/en/latest/models.html#nutrient-delivery-ratio">Nutrient Delivery Ratio</a>. The biophysical table specifies the nutrient retention by vegetation using various variables, e.g., root depth and more detailed soil properties described in the <code>natcap.invest</code> documentation.</p>
</section>
<section id="POL" class="level4" data-number="3.6.1.5">
<h4 data-number="3.6.1.5" class="anchored" data-anchor-id="POL"><span class="header-section-number">3.6.1.5</span> POL: Pollination and dispersal of seeds</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb24" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">POL</span><span class="kw">:</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 1_POL_S_CH.py</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # Farm vector path</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">farm_vector_path</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">  # Guild table path</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">guild_table_path</span><span class="kw">:</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/POL/BPTABLE/guild.csv</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">  # Landcover biophysical table path</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">landcover_biophysical_table_path</span><span class="kw">:</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/POL/BPTABLE/pollination_bptable_ds25_futei.csv</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">  # 2_POL_S_CH_aggregating.R</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>POL</code> NCP calculates the <code>natcap.invest</code> <a href="https://invest.readthedocs.io/en/latest/models.html#crop-pollination">Crop Pollination model</a>. Followed by an aggregation step in R.</p>
</section>
<section id="REC" class="level4" data-number="3.6.1.6">
<h4 data-number="3.6.1.6" class="anchored" data-anchor-id="REC"><span class="header-section-number">3.6.1.6</span> REC: Recreation potential</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb25" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">REC</span><span class="kw">:</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 1_REC.R</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # lulc naturality lookup table</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">lutable_nat_path</span><span class="kw">:</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/REC/BPTABLE/lutable_naturality.csv</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>REC</code> NCP returns a Recreation Potential (RP) indicator. This is a normalized aggregate of three landscape characteristics maps:</p>
<ul>
<li>Degree of naturalness (DN): Aggregate sum of naturalness scores for each LULC class.</li>
<li>Natural protected areas (NP): Binary map of <code>0=outside</code> protected areas, <code>1=inside</code> protected areas.</li>
<li>Water components (W): Inverse relative distance to lake coasts, with the highest value at the lake coast and a decreasing value for 2 km.</li>
</ul>
<p>The output is a single map of recreation potential.</p>
</section>
<section id="SDR" class="level4" data-number="3.6.1.7">
<h4 data-number="3.6.1.7" class="anchored" data-anchor-id="SDR"><span class="header-section-number">3.6.1.7</span> SDR: Formation, protection and decontamination of soils</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb26" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">SDR</span><span class="kw">:</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 1_SDR_S_CH.py</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # Biophysical table</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">biophysical_table_path</span><span class="kw">:</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/SDR/BPTABLE/bptable_SDR_v2_futei.csv</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # Drainage path</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ic_0_param</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.4</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">k_param</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">l_max</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">  # SDR max</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sdr_max</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.75</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">  # Threshold flow accumulation</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">threshold_flow_accumulation</span><span class="kw">:</span><span class="at"> </span><span class="dv">200</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sediment export and retention are calculated in the <code>SDR</code> NCP with the <a href="https://invest.readthedocs.io/en/latest/models.html#sediment-delivery-ratio">Sediment Delivery Ratio model</a> from <code>natcap.invest</code>.</p>
</section>
<section id="WY" class="level4" data-number="3.6.1.8">
<h4 data-number="3.6.1.8" class="anchored" data-anchor-id="WY"><span class="header-section-number">3.6.1.8</span> WY: Regulation of freshwater quantity, location and timing</h4>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/40_NCPs/NCP_models/40_NCPs_params.yml</strong></pre>
</div>
<div class="sourceCode" id="cb27" data-filename="src/steps/40_NCPs/NCP_models/40_NCPs_params.yml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">WY</span><span class="kw">:</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # 1_WY_S_CH.py</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">  # Biophysical table</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">biophysical_table_path</span><span class="kw">:</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">    evoland-plus HPC/src/steps/40_NCPs/NCP_models/WY/BPTABLE/wy_bptable_ds25_futei.csv</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # Seasonality constant</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">seasonality_constant</span><span class="kw">:</span><span class="at"> </span><span class="dv">25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="https://invest.readthedocs.io/en/latest/models.html#annual-water-yield">Annual Water Yield</a> is the final NCP calculated in this step. The <code>WY</code> NCP calculates the hydropower potential.</p>
</section>
</section>
<section id="running-the-ncp-calculation" class="level3" data-number="3.6.2">
<h3 data-number="3.6.2" class="anchored" data-anchor-id="running-the-ncp-calculation"><span class="header-section-number">3.6.2</span> Running the NCP calculation</h3>
<p>Assuming the <code>ncps</code> environment is set up, all previous configurations are correctly set, the input data is available, and the FF NCP has been prepared using <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/40_NCPs/NCP_models/prepare_ncps.sh"><code>src/steps/40_NCPs/NCP_models/prepare_ncps.sh</code></a>, the NCP calculation can be started.</p>
<p>To calculate all NCP for one scenario and year, the <code>run_all_ncps.py</code> script bundles the execution of all NCP. It is used like so:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage: bash run_all_ncps.sh &lt;NCP_RUN_SCENARIO_ID&gt; &lt;NCP_RUN_YEAR&gt; &lt;NCP_RUN_INPUT_DIR&gt; &lt;NCP_RUN_OUTPUT_DIR&gt; &lt;NCP_RUN_SCRATCH_DIR&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> src/steps/40_NCPs/NCP_models/run_all_ncps.sh 1 2015 /path/to/input_dir /path/to/output_dir /path/to/scratch_dir</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The simplified execution of this using the HPC scheduler SLURM is done with <code>sbatch src/steps/40_NCPs/NCP_models/slurm_job.sh</code>. The scenario ID and year are set in the job script.</p>
<p>The full, parallelized execution of the evoland-plus HPC pipeline for all scenarios with LULCC and NCP calculation is done with the <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/10_40_combined_array_job.sh"><code>10_40_combined_array_job.sh</code></a> script and SLURM, for this consult the following <a href="running.html">Running section</a>.</p>
<div id="note-ncp-output" class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
NCP output check
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>src/steps/40_NCPs/show_files.py</code> script shows existing NCP results by scenario. It reads numbers from files to generate a histogram of counts and checks if each expected file is present in each scenario. The script outputs a summary table of file coverage and lists any missing or unexpected files. Missing files are saved to <code>scenarios_with_missing_files.txt</code>, and unexpected files are saved to <code>unexpected_files.txt</code>. Such unexpected files might be intermediate files that are not cleaned up properly and can be deleted.</p>
</div>
</div>
</section>
</section>
<section id="running" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="running"><span class="header-section-number">3.7</span> Running</h2>
<p>The pipeline is executed in three parts, each part is a separate Slurm job. Remember <a href="../structure.html#fig-pipeline" class="quarto-xref">Figure&nbsp;<span>2.1</span></a> from the <a href="../structure.html">Structure</a> section. The most computationally intensive steps, LULCC and NCP are parallelized and submitted as one Slurm array job. For all of these steps, you need to have followed the previous sections to set up and configure the pipeline. This includes preparing the FF NCP using <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/40_NCPs/NCP_models/prepare_ncps.sh"><code>src/steps/40_NCPs/NCP_models/prepare_ncps.sh</code></a> and filling the <a href="10_LULCC.html#simulation-control-table">simulation control table</a> with all the scenarios you want to run.</p>
<section id="evoland-plus-hpc-pipeline" class="level3" data-number="3.7.1">
<h3 data-number="3.7.1" class="anchored" data-anchor-id="evoland-plus-hpc-pipeline"><span class="header-section-number">3.7.1</span> evoland-plus HPC pipeline</h3>
<p><strong>Land Use Simulation</strong> and <strong>NCP Estimation</strong> can separately be calculated for one scenario with the jobs <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/10_LULCC/slurm_job.sh"><code>src/steps/10_LULCC/slurm_job.sh</code></a> and <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/40_NCPs/slurm_job.sh"><code>src/steps/40_NCPs/slurm_job.sh</code></a>. The <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/10_40_combined_array_job.sh"><code>10_40_combined_array_job.sh</code></a> slurm job calculates both steps for all scenarios in parallel. Each array job receives a subset of the scenarios to calculate. All scenarios are calculated in parallel with the following slurm job:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> src/steps/10_40_combined_array_job.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This would submit the job to the cluster and start the calculation with the default settings.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/steps/10_40_combined_array_job.sh</strong></pre>
</div>
<div class="sourceCode" id="cb30" data-filename="src/steps/10_40_combined_array_job.sh"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name="10_40_combined_array"</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -n 1                  # Number of cores requested</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=2     # Number of CPUs per task</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=7-00:00:00     # Runtime in D-HH:MM:SS</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem-per-cpu=2G</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --tmp=2G</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output="logs/10_40_combined_array-%j.out"</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error="logs/10_40_combined_array-%j.err"</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=NONE      # Mail events (NONE, </span><span class="re">BEGIN</span><span class="co">, </span><span class="re">END</span><span class="co">, FAIL, ALL)</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">## Array job</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-216%12      # start-end%num_parallel</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co">#        ! step size needs to be 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The speed-up of the combined job is achieved by running multiple scenarios in parallel. We do this, as the speed-up assigning more CPUs to one scenario is limited. Each of the 216 array jobs is assigned one core with two CPUs and 4&nbsp;GB of memory. <code>%12</code> in the array specification ensures that 12 array jobs are run in parallel, if one job finishes, the next one is started. Each array job has a time limit of 7 days.</p>
<p>In our case, we had 1080 scenarios to calculate, so we set the array job to run 216 scenarios in parallel to have five scenarios per array job. Before, we have tested with only having one scenario in the simulation control table, 10&nbsp;GB of memory, and <code>SBATCH --array=1-1</code> to check if the job runs correctly. Running the Switzerland map at a resolution of 100&nbsp;m by 100&nbsp;m, the job took 6:23:06 hours to complete at a CPU efficiency of 75.29% and a memory efficiency of 75.58%. With <code>tail -f logs/10_40_combined_array_-*.out logs/10_40_combined_array_-*.err</code> it is easy to monitor the progress of the job. For explanations and more details on the <code>sbatch</code> options, see the <a href="https://slurm.schedmd.com/sbatch.html#SECTION_OPTIONS">Slurm documentation</a>.</p>
<p>When running a large array of scenarios, the array jobs vary in the amount of memory they require and time they take. It is a valid approach to start with a memory limit that works for the majority of scenarios. Some jobs might fail due to memory issues, but after all array jobs have finished, it is possible to rerun the failed scenarios with a higher memory limit. This is possible because the LULCC and NCP are only calculated if each output file is missing, down to the level of each NCP.</p>
<div id="note-maxarraysize" class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>The cluster might have a limit on the number of array jobs that can be run in parallel. To find out the limit, use <code>scontrol show config | grep MaxArraySize</code>.</p>
</div>
</div>
</div>
<p>To get a simple estimation on how long the job array takes, you can use cross-multiplication, starting with the time it took to calculate one scenario <span class="math inline">\(t_{\text{one}}\)</span>. With the number of scenarios <span class="math inline">\(n_{\text{all}}\)</span> and the number of scenarios calculated in parallel <span class="math inline">\(n_{\text{parallel}}\)</span>, the time it takes to calculate all scenarios <span class="math inline">\(t_{\text{all}}\)</span> is:</p>
<p><span class="math display">\[
t_{\text{all}} = \frac{n_{\text{all}}}{n_{\text{parallel}}} \times t_{\text{one}}
\]</span></p>
<div id="tip-parallel" class="callout callout-style-simple callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip&nbsp;3.1: Selective running
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you only want to either run the LULCC or the NCP, you can modify the <code>10_40_combined_array_job.sh</code> script to only run the respective part. This comes down to commenting-out one line in the script.</p>
</div>
</div>
</section>
<section id="check-lulcc-and-focal-lulc" class="level3" data-number="3.7.2">
<h3 data-number="3.7.2" class="anchored" data-anchor-id="check-lulcc-and-focal-lulc"><span class="header-section-number">3.7.2</span> Check LULCC and Focal LULC</h3>
<p>As explained in their respective sections, the steps <a href="11_CheckLULCC.html">Check LULCC</a> and <a href="20_FocalLULC.html">Focal LULC</a> can be already run after the LULC layers are present. Both <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/11_CheckLULCC/slurm_job.sh"><code>src/steps/11_CheckLULCC/slurm_job.sh</code></a> and <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/steps/20_FocalLULC/slurm_job.sh"><code>src/steps/20_FocalLULC/slurm_job.sh</code></a> are also submitted with <code>sbatch</code>. In contrast, these are simple jobs and their parallelization is achieved by assigning more CPUs to the job and using R’s asynchronous processing <a href="https://rdrr.io/cran/future/man/multisession.html"><code>future::plan(future::multisession)</code></a>.</p>
</section>
<section id="logging" class="level3" data-number="3.7.3">
<h3 data-number="3.7.3" class="anchored" data-anchor-id="logging"><span class="header-section-number">3.7.3</span> Logging</h3>
<p>There are multiple levels of logging in the pipeline. When running the Slurm jobs, the output and error logs are written to the specified files. These are coming from three main sources: the R scripts, the Python scripts, and the Slurm job scripts. Generally, slurm logs are written to the file specified in the job script. For the logs regarding the scripts written for this pipeline, <code>FUTURE_EI_LOG_LEVEL: debug</code> in the <code>config.yml</code> file can be set to <code>debug</code>, <code>info</code>, <code>warning</code>, or <code>error</code>. The NCP calculation uses <code>natcap.invest</code> which has detailed logs written to the console. For the LULCC container, Dinamica EGO has more detailed logs of the integrated R scripts. They are written to the mounted <code>LULCC_CH_HPC_DIR</code> directory and do not show up in the Slurm logs. Dinamica EGO has a separate log level that can be set through the <code>DINAMICA_EGO_CLI_LOG_LEVEL</code> environment variable.</p>
</section>
</section>
<section id="further-steps" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Further Steps</h1>
<p>Upon completing the four steps, we obtain LULC layers, focal windows, and NCP. These outputs can be further analyzed and utilized for additional processes, such as species distribution modeling.</p>
<p>In our scenario, we have incorporated a fifth step that leverages the same repository structure and configuration as the previous steps. The code for this step is located in a different repository, which ensures that the workflow remains consistent and manageable. This additional step allows for more comprehensive analysis and extends the capabilities of the initial four steps, providing a robust framework for further research and application.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-lulcc2024" class="csl-entry" role="listitem">
Black, Benjamin. 2024. <span>“LULCC-CH Source Code.”</span> GitHub. <a href="https://github.com/blenback/LULCC-CH">https://github.com/blenback/LULCC-CH</a>.
</div>
<div id="ref-black2025" class="csl-entry" role="listitem">
Black, Benjamin, Antoine Adde, Nathan Külling, Carlson Büth, Manuel Kurmann, Anthony Lehmann, Florian Altermatt, Antoine Guisan, and Adrienne Gret-Regamey. 2025. <span>“Identifying Robust Conservation Strategies to Secure Ecosystem Service Provision Under Uncertainties.”</span>
</div>
<div id="ref-Hackett1991" class="csl-entry" role="listitem">
Hackett, C. 1991. <span>“Mobilising Environmental Information about Lesser-Known Plants: The Value of Two Neglected Levels of Description.”</span> <em>Agroforestry Systems</em> 14 (2): 131–43. <a href="https://doi.org/10.1007/bf00045728">https://doi.org/10.1007/bf00045728</a>.
</div>
<div id="ref-kuelling2024" class="csl-entry" role="listitem">
Külling, Nathan, Antoine Adde, Audrey Lambiel, Sergio Wicki, Antoine Guisan, Adrienne Grêt-Regamey, and Anthony Lehmann. 2024. <span>“Nature’s Contributions to People and Biodiversity Mapping in Switzerland: Spatial Patterns and Environmental Drivers.”</span> <em>Ecological Indicators</em> 163: 112079. <a href="https://doi.org/10.1016/j.ecolind.2024.112079">https://doi.org/10.1016/j.ecolind.2024.112079</a>.
</div>
<div id="ref-dinamicaEGO" class="csl-entry" role="listitem">
Leite-Filho, Argemiro T., Britaldo S. Soares-Filho, Juliana L. Davis, and Hermann O. Rodrigues. 2020. <em>Modeling Environmental Dynamics with Dinamica EGO</em>. Centro de Sensoriamento Remoto. Universidade Federal de Minas Gerais, Belo Horizonte, Minas Gerais. <a href="https://www.csr.ufmg.br/dinamica/dokuwiki/doku.php?id=guidebook_start">https://www.csr.ufmg.br/dinamica/dokuwiki/doku.php?id=guidebook_start</a>.
</div>
<div id="ref-r2022" class="csl-entry" role="listitem">
R Core Team. 2022. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>The installed CLI is identified via bash variables in <a href="https://github.com/ethzplus/evoland-plus-HPC/tree/main/src/bash_common.sh"><code>src/bash_common.sh</code></a>. If none is found, an error highlights the issue.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The Docker version used is <code>24.0.7</code>, but the container should be compatible with most versions.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>We have used <code>yq</code> <code>v4.40.3</code>, but any version <code>&gt;=4.18.1</code> should work.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>The versions of the R packages used with LULCC are listed in the note below.</p>
<div id="note-versions" class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
R Packages
</div>
</div>
<div class="callout-body-container callout-body">
<p>Versions used with <a href="https://hub.docker.com/repository/docker/cbueth/lulcc/general">LULCC docker</a> <code>0.3.0</code>:</p>
<ul>
<li>raster: <code>3.6-26</code></li>
<li>tidyverse: <code>2.0.0</code></li>
<li>data.table: <code>1.15.4</code></li>
<li>randomForest: <code>4.7-1.1</code></li>
<li>callr: <code>3.7.6</code></li>
<li>future: <code>1.33.2</code></li>
<li>future.apply: <code>1.11.2</code></li>
<li>future.callr: <code>0.8.2</code></li>
<li>sp: <code>2.1-3</code></li>
<li>stringi: <code>1.8.3</code></li>
<li>stringr: <code>1.5.1</code></li>
</ul>
</div>
</div>
<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></li>
<li id="fn5"><p>For more information on the compatibility of Dinamica EGO with Linux, see the <a href="https://dinamicaego.com/dokuwiki/doku.php?id=dinamica_linux_compatibility">Dinamica EGO documentation</a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>The versions of the packages used in the NCP calculation are listed in the note below.</p>
<div id="note-versions-ncp" class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Versions used for the NCP calculation
</div>
</div>
<div class="callout-body-container callout-body">
<p>R (<code>4.1.3</code>) packages:</p>
<ul>
<li>raster: <code>3.4-13</code></li>
<li>terra: <code>1.5-21</code></li>
<li>meteor: <code>0.4.5</code></li>
<li>Recocrop: <code>0.4.0</code></li>
<li>rgdal: <code>1.5-29</code></li>
<li>codetools: <code>0.2-19</code></li>
<li>data.table: <code>1.14.8</code></li>
<li>remotes: <code>2.4.2</code></li>
<li>sf: <code>1.0-7</code></li>
<li>yaml: <code>2.3.7</code></li>
</ul>
<p>Python (<code>3.10.13</code>) packages:</p>
<ul>
<li>natcap.invest: <code>3.13.0</code></li>
</ul>
</div>
</div>
<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../structure.html" class="pagination-link" aria-label="Structure">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Structure</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../summary.html" class="pagination-link" aria-label="Summary">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Summary</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ethzplus/evoland-plus-HPC/issues/new/choose" class="toc-action"><i class="bi bi-chat-right"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>